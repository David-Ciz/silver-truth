## Silver Truth Generation Algorithm

The "silver truth" in this project refers to a computer-generated reference annotation, derived from the majority opinion of multiple competitive cell tracking algorithms. This process is crucial for creating robust benchmarks for evaluating new algorithms in cell tracking challenges.

### Overview of the Fusion Process

The generation of silver truth is primarily handled by the `cli_fusion.py` script, which acts as a Python wrapper around a powerful Java-based fusion tool, specifically the `Annotations Fusing tools` plugin (packaged as a standalone JAR file). This approach allows us to leverage the robust fusion capabilities of the Java tool while providing a convenient command-line interface through Python.

The general workflow for generating silver truth involves:

1.  **Preparing Input Data**: Ensuring that synchronized segmentation results from various competitor algorithms are available.
2.  **Generating Job Files**: Creating a job specification file that lists the input image patterns for the fusion tool. This is done using the `generate-jobfiles` command within `cli_fusion.py`.
3.  **Running the Fusion Tool**: Executing the Java fusion tool via the `run-fusion` command in `cli_fusion.py`, providing the job file and other necessary parameters.

### The `cli_fusion.py` Script

The `cli_fusion.py` script provides two main commands:

#### 1. `generate-jobfiles`

This command prepares the input for the fusion process by creating a job specification file. This file tells the fusion tool which images from which competitors to consider for fusion.

**Usage:**

```bash
python cli_fusion.py generate-jobfiles --parquet-file <path_to_parquet_file> --campaign-number <campaign_number> --output-dir <output_directory> [OPTIONS]
```

**Key Parameters:**

*   `--parquet-file`: Path to the Parquet dataset file (e.g., `BF-C2DL-HSC_dataset_dataframe.parquet`), which contains metadata about the synchronized datasets and competitor results.
*   `--campaign-number`: A unique identifier for the current fusion campaign (e.g., `'01'`).
*   `--output-dir`: Directory where the generated job file will be saved.
*   `--tracking-marker-column` (optional): The column name in the parquet file that contains the tracking marker paths (default: `tracking_markers`).
*   `--competitor-columns` (optional, can be specified multiple times): Column names in the parquet file that contain competitor result paths. If not provided, all columns except known non-competitor columns will be considered.

**Example:**

```bash
python cli_fusion.py generate-jobfiles --parquet-file BF-C2DL-HSC_dataset_dataframe.parquet --campaign-number 01 --output-dir job_files
```

#### 2. `run-fusion`

This command executes the actual segmentation fusion process using the Java JAR. It takes the generated job file and other configuration parameters to produce the fused silver truth segmentations.

**Usage:**

```bash
python cli_fusion.py run-fusion --jar-path <path_to_jar> --job-file <path_to_job_file> --output-pattern <output_pattern> --time-points <time_points> --num-threads <num_threads> --model <model> [OPTIONS]
```

**Key Parameters:**

*   `--jar-path` (required): Path to the executable Java JAR file (e.g., `fusers-all-dependencies.jar`). This JAR encapsulates the `Annotations Fusing tools`.
*   `--job-file` (required): Path to the job specification file generated by `generate-jobfiles`.
*   `--output-pattern` (required): Output filename pattern for the fused images, including `TTT` or `TTTT` placeholders for time points (e.g., `/path/to/fused_TTT.tif`).
*   `--time-points` (required): A string specifying the time points to process (e.g., `"1-9,23,25"`).
*   `--num-threads` (required): Number of processing threads to use for the fusion.
*   `--model` (required): The fusion model to use. Available models are defined by the `FusionModel` enum in `src/fusion/fusion.py` (e.g., `weighted_average`, `majority_vote`).
*   `--threshold` (optional): Voting threshold for merging (default: `1.0`).
*   `--cmv-mode` (optional): Enable Combinatorial Model Validation mode (e.g., `"CMV"`, `"CMV2_8"`).
*   `--seg-folder` (optional): Optional path to ground truth folder for scoring during fusion.
*   `--debug` (optional): Enable debug logging and show Java process output.

**Example:**

```bash
python cli_fusion.py run-fusion --jar-path src/data_processing/cell_tracking_java_helpers/label-fusion-ng-2.2.0-SNAPSHOT-jar-with-dependencies.jar --job-file job_files/BF-C2DL-HSC_01_job_file.txt --output-pattern data/fused/BF-C2DL-HSC_fused_TTT.tif --time-points "1-10" --num-threads 4 --model "weighted_average"
```

### Fusion Models

The `--model` parameter in `run-fusion` allows selection of different fusion algorithms. These correspond to the `FusionModel` enum in `src/fusion/fusion.py`. Common models include:

*   **`weighted_average`**
*   **`majority_vote`**

### Inputs Required by the Java Plugin

The underlying Java `Annotations Fusing tools` plugin primarily requires:

*   **Input Segmentation Images**: These are the individual segmentation results from various competitor algorithms, typically in `.tif` format.
*   **Job Specification File**: A text file (generated by `generate-jobfiles`) that lists the paths to these input images for each time point and competitor.

### Outputs of the Fusion Process

The `run-fusion` command outputs the fused segmentation images, which represent the generated silver truth. These are typically `.tif` files following the specified `--output-pattern`.